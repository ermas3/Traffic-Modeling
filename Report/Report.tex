\documentclass[a4paper,12pt]{article}

\usepackage{geometry}       % Required for page layout.
\usepackage{hyperref}       % Required for hyperlinks.
\usepackage{graphicx}       % Required for figures.
\usepackage{subfig}         % Required for minipages.
\usepackage{float}          % Requried for optimal figure placement

\newgeometry{vmargin={25.4mm}, hmargin={27mm,27mm}}
\setlength\parindent{0pt}   % Disable paragraph indent.

\title{Studying the flow rate on a multi-lane using a cellular automata model}
\author{Erik Åsgrim}

\begin{document}
\maketitle

\section*{Introduction}
\subsection*{Background}
When planning traffic infrastructure achieving efficient and safe traffic flow is highly important.
A possible way of measuring how well traffic is flowing on a road is by studying the flow rate.
The flow rate on a road is defined as the sum of the velocities of the cars on the road divided by the length of the road.
In real life situations maximizing the flow rate could thus often be of interest. Another interesting metric to study is the fluctuations of the 
flow rate. If the flow rate does not fluctuate much the traffic flow is behaving in a stable way which could imply easier
driving conditions and a reduced risk of accidents.

In this report we will investigate how the flow rate behavior depends on the amount of lanes on the road and the car density by simulating
a highway using a cellular automata model.

\subsection*{Model description}
The model of the highway was implemented as a cellular automata. The road was given some integer distance $L$ where each car on the road occupied $1$ length unit of the road. 
Periodic boundary conditions were used, meaning that the road did not have an end nor a beginning. The distance between the cars therefore also had to be calculated as periodic distances.
In order to make the dynamics of the simulation more realistic all cars were given personal maximum velocities $v_{i,max}$. The values of $v_{i, max}$ were randomly generated 
from a Gaussian distribution around some mean value $\mu$ and standard deviation $\sigma$, and then rounded to the nearest integer.
%where $\mu$ would represent the speed limit on the road. A Gaussian distribution of the values of $v_{i, max}$ thus
%seems logical since in real life most cars drive at approximately the speed limit even though a few cars drive much faster or slower.

The rules for the cellular automata were performed in two different parts at each time step.
First, rules determining what lane changes are going to be performed are implemented. This was done by first calculating the desired lane change of each car and then
performing the desired lane change only if the lane change can be performed safely.
Secondly, rules determining how the various cars are going to change their velocity are implemented.
Each rule was implemented simultaneously on each car before moving on to the next rule. This means that the ordering of the rules is very important, as latter rules can overrule previous decisions.
In order to make the rules more compact we also introduce the following notation

\begin{itemize}
    \item $x_i$ is the position of the i:th car
    \item $v_i$ is the velocity of the i:th car
    \item $v_{i, max}$ is the maximum velocity of the i:th car.
    \item $v_{back}$ is the velocity to the next car backward in the \textbf{new lane} we would like to change to.
    \item $d_{forward}$ is the distance forward to the next car in the same lane we are currently in.
    \item $d_{forward, left}$ is the distance forward to the next car in the lane to the left.
    \item $d_{forward, right}$ is the distance forward to the next car in the lane to the right.
    \item $d_{backward}$ is the distance backward to next car in the \textbf{new lane} we would like to change to.
\end{itemize}

Using the above notation the rules of the cellular automata were implemented as follows:

\vspace{5pt}
\textbf{Lane changes}
\begin{enumerate}
    \item If $v_i<v_{i,max}$ and $d_{forward, left}\geq d_{forward}$ and there exists a lane to the left, desire a lane change from right to left
    \item If $d_{forward} > v_{i, max}$ and $d_{forward, right} > v_{i, max}$ and there exists a lane to the right, desire a lane change from left to right
    \item If $d_{forward, right} > d_{forward}$ and no previous lane change desire exists, desire a lane change from left to right with $5\%$ probability
    \item If $d_{backward} > v_{back}$ perform desired lane change (car behind should not need to brake because of lane change)
\end{enumerate}

\textbf{Velocity changes}
\begin{enumerate}
    \setcounter{enumi}{4}
    \item If $v_i<v_{i, max}$ increase velocity as $v_i \rightarrow v_i+1$ (try to accelerate to maximum velocity)
    \item If $v \geq d_{forward}$ decrease velocity as $v = d_{forward} - 1$ (avoid collisions)
    \item With some probability $p$ decrease velocity as $v_i=v_i-1$ (cars might brake randomly)
    \item Update position as $x_i(t+1) = x_i(t) + v_i$
\end{enumerate}

% Om det får plats, förklara logiken mer ingående av varje regel.
The rules above result in a behavior of the cars that appears natural. Rule (3) might however need some
clarification. Without rule (3) mostly the left lane becomes occupied for higher car densities. In order to solve this, rule (3) creates
a bias towards changing to the right lane which solves the problem. An example of a lane changing scenario from left to right is seen in figure
\ref*{left to right}. An example of a lane changing scenario from right to left is seen in figure ... %TODO .

\begin{figure}[H]
    \centering
    \includegraphics[scale=0.6]{Images/Bilbild.jpg}
    \caption{Example of distance caluclations for the i:th car marked in red. The car has a desired
    lane change to the left since $v_i < v_{i, max}$ and $d_{forward_left}>d_{forward}$. The desired lane change
    is allowed since $d_{back} > v_{back}$.}
    \label{left to right}
\end{figure}

% diskutera hur diskretiseringen av rum och tid kan påverka!!

\section*{Problem description}
The purpose of this report is to simulate a multi-lane highway and compare how the flow rate is affected by varying the number
of lanes at different car densities.
To do a statistical analysis of the result we would also like to examine the standard error of the flow rate and investigate whether the 
standard error of the flow rate varies depending on the car density and the number of lanes.

\section*{Method}
\subsection*{Setting the system size}
Initially we must choose a system size to run the simulations on where finite size effects can be considered negligble. This is done plotting fundamental
diagrams of the system while iteratively increasing the road length $L$. When generating the fundamental diagrams the car density is increased by increasing the number
of cars and keeping the road length $L$ constant. This is done separately using 1, 2 and 3 lanes, while keeping remaining system
parameters constant. At a certain road length $L$ the fundamental diagrams will not change as the road length
continues to increase, meaning that the system behavior has become independant of its size. When a road length $L$ is found such that the fundamental diagrams
do not continue to change as $L$ increases the road length will be set to thath value for the following simulations.

\subsection*{Flowrate}
To get an understanding of the flow rate behavior and the time necessary to reach equilibrium, the flow rate is plotted against time using a few different 
car densities and the road length $L$ found in the previous section. Fundamental diagrams are also generated for using 1, 2 and 3 lanes. Just like previously,
the road length $L$ is always kepts constant while generating the fundamental diagrams and only the number of cars is increased.

\subsection*{Statistical analysis}
In order to examine the statistical accuracy of the results we will study the standard error of the average flow rate after running the simulation multiple times. 
The average flow rate is calculated as an average over 100 time steps after the system has reached an equilibrium. Initially, we will examine how the standard error
depends on the number of simulation using a few different car densities. To get a better understanding of behavior of the standard error the standard error will be calculated
at many differernt car densities to get a diagram of how the standard error depends on the car density. This is all done using 1, 2 and 3 lanes separately.



\section*{Results and analysis}
\subsection*{Setting the system size}
%Köra 10 gånger för att minska brus
The values of $v_{i,max}$ were sampled from a Gaussian distribution with mean $\mu = 10$ and standard deviation $\sigma = 1$. The braking probability
was set to $p=0.2$. Note that these simulation parameters remained unchanged during all following simulations. The cars were initally placed one unit length ahead 
of each other in one lane... % TODO BESKRIV INITIAL CONDITIONS FÄRDIGT.

Fundamental diagrams were generated by increasing the number of cars $n_{cars}$ so that the car density varied between 0 and 1. 
The simulation was run for 200 time steps and the flow rate was calculated as an average over the last 100 time steps.
This was done using the different values of the road length $L=20, 40, 60, 80, 100, 120, 140$. In order to reduce random noise in the fundamental diagrams
10 fundamental diagrams were generated for each value of $L$ and a final fundamental diagram was calculated as an average over these 10 fundamental diagrams.
This procedure was done separately using 1, 2 and 3 lanes.
The results can be seen below in figure \ref*{finite size effects}.

\begin{figure}[H]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/fundamental diagrams 1 lane 140.png}
        \captionof*{figure}{a) 1 lane}
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/fundamental diagrams 2 lanes 140.png}
        \captionof*{figure}{b) 2 lanes}
    \end{minipage}
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/fundamental diagrams 3 lanes 140.png}
        \captionof*{figure}{c) 3 lanes}
    \end{minipage}%
    \caption{Fundamental diagrams using different road lenghts $L$ using 1, 2 and 3 lanes.}
    \label{finite size effects}
\end{figure}

In figure \ref*{finite size effects} we observe that the largest changes in the fundamental diagrams when increasing $L$ occur around the
peak of the fundamental diagrams when the average flow rate is maximal. In figure \ref*{finite size effects} a) when using only 1 lane it appears
as if the system becomes independant of its size at approximately $L=60$, as we can no longer see a change in the fundamental diagrams when increasing
$L$ beyond thi value. When increasing the number of lanes a larger value of $L$ appears to be necessary to make the system independant of its size. 
In figure \ref*{finite size effects} a) it appears as if $L=100$ before the fundamental diagram stops changing when using 2 lanes. When increasing the number
of lanes to 3 it appears as if $L=120$ is necessary before the fundamental diagrams stop changing, as can be seen in figure \ref*{finite size effects} c).
We thus conclude that a road length $L=120$ appears to be necessary in order to mitigate finite size effect, and therefore $L=120$ will be used
in following simulations.

\subsection*{Flow rate}
We plot the flowrate over time while using road length $L=120$, and setting the number of cars to $n_{cars}=10, 30, 50, 70$. This is done using 1, 2 and 3 lanes.
The resulting plots of the flowrate against time can be seen below in figure \ref*{flowrate}
\begin{figure}[H]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/flowrate time 10 cars.png}
        \captionof*{figure}{a) 10 cars}
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/flowrate time 30 cars.png}
        \captionof*{figure}{b) 30 cars}
    \end{minipage}
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/flowrate time 50 cars.png}
        \captionof*{figure}{c) 50 cars}
    \end{minipage}%
    %\begin{minipage}{.5\textwidth}
    %    \centering
    %    \includegraphics[scale=0.47]{Images/flowrate time 70 cars.png}
    %    \captionof*{figure}{d) 70 cars}
    %\end{minipage}
    \caption{Flowrate plotted against time using different number of cars.}
    \label{flowrate}
\end{figure}
In figure \ref*{flowrate} we notice multiple interesting things with the flowrate behavior. When $n_{cars}=10$ there is a large gain in the flowrate when increasing
the number of lanes from 1 to 2, while the difference between 2 and 3 lanes is small. The fluctuations of the flowrate for the road with 1 lane also
appears to be much larger than when using 2 or 3 lanes. When setting $n_{cars}=20, 30$ the we start to see a large gain in the average flow rate when using 3 lanes instead 2.
Interestingly we also notice that the fluctuations seems to have decreased when using 1 lane and increased when using 2 and 3 lanes. Similar results are seen with $n_cars = 40$
as we are getting large differences in the averge flow rate using different lanes, with increasing fluctuations of the flow rate as the number of lanes increase.
It thus appears as if the car density has a large effect on both the average flow rate and the fluctuations of the flow rate.

To get a better understanding of the system dynamics fundamental diagrams are plotted. The average flowrate is calculated as an average over the last $100$ time steps when running
the simulation for 200 time steps. The road length $L=100$ is held constant and $n_{cars}$ is iteratively
increased in order to increase the car density between 0 and 1. The results are seen below in figure \ref*{fundamental diagram}.

\begin{figure}[H]
    \centering
    \includegraphics[scale=0.9]{Images/fundamental diagram 120.png}
    \caption{Average flow rate plotted against car density for different number of lanes.}
    \label{fundamental diagram}
\end{figure}

In \ref*{flowrate} we see that the flow rate appears to grow linearly until a clear maximum value is reached. Increasing the car density beyond
that value the flow rate appears to decrease, also somewhat linearly. For low car densities the average flow rate appears independant of the number of lanes.
This is reasonable since we should not be expecting a gain in the flowrate by having a large amount of lanes when very few cars are on the road.
For car densities larger than approximately 0.3 we see a large gain in the average flow rate when increasing the number of lanes. Interestingly, the gain in the
flow rate when increasing the number of lanes from 1 to 2 appears to be exactly the same as the gain acquired when increasing the number of lanes of 2 to 3.
Overall, the results appear logical and serve as a good confirmation that the model appears to behave realistically.

\subsection*{Statistical accuracy}
We will now examine the statistical accuracy by calculating the standard error. Just like in the previous section we initially run the simulation
using $n_{cars}=10, 20, 30, 40$. Simulations are run for 200 time steps and the flow rate is calculated as an average over the last 100 time steps.
We run the simulations a number of times and calculate the standard error of the flow rate values using 1, 2 and 3 lanes. Diagrams showing the
standard error of the flow rate plotted against the number of simulations run are seen below in figure \ref*{standard error 1}

\begin{figure}[H]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/standard error 10 cars 120.png}
        \captionof*{figure}{a) 10 cars}
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/standard error 30 cars 120.png}
        \captionof*{figure}{b) 30 cars}
    \end{minipage}
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[scale=0.47]{Images/standard error 50 cars 120.png}
        \captionof*{figure}{c) 50 cars}
    \end{minipage}%
    %\begin{minipage}{.5\textwidth}
    %    \centering
    %    \includegraphics[scale=0.47]{Images/standard error 70 cars 120.png}
    %    \captionof*{figure}{d) 70 cars}
    %\end{minipage}
    \caption{Standard error of average flowrate plotted against amount of simulations using different number of cars.}
    \label{standard error 1}
\end{figure}

When using $n_{cars}=10$ it is clear that the standard error of the flow rate is much larger when using 1 lane compared to 2 or 3 lanes.
When $n_{cars}=20$ the standard error is largest when using 2 lanes and the standard error when using 1 lane appears to have decreased.
Setting the number of cars to $n_{cars}=20, 30$ we instead see the highest standard error when using 3 lanes and lower standard error than before 
when using 1 or 2 lanes. These large differences in the standard error depending on the number of lanes and the car density appear to 
be consistent with the results seen previously in figure \ref*{flowrate}.

To get a better understanding of the stand error dependance on the car density we calculate the standard error for varying car densities.
The road length remained fixed at $L=100$ and $n_{cars}$ varies in order to vary the car density between 0 and 1. For each car density 100 simulation are run
for 200 time steps where the flow rate is calculated as an average over the last 100 time steps. The standard error of these values is than calculated.
This is done using 1, 2 and 3 lanes. The results can be seen below in figure \ref*{standard error}

\begin{figure}[H]
    \centering
    \includegraphics[scale=0.9]{Images/standard error 120.png}
    \caption{Standard error of average flow rate plotted against car density for different number of lanes.}
    \label{standard error}
\end{figure}

In figure \ref*{standard error} we notice that the plots of the standard error against the car density are somewhat similar to the fundamental diagrams
in figure \ref*{fundamental diagram}. For all number of lanes, we initially see a clear increase of the standard error as the car density increases
until a clear peak value is reached. Increasing the car density further makes the standard error decrease. When comparing the different number of lanes we primarily
see two main differences. Firstly, we notice that the car density for which the standard error reaches its maximum value is larger when increasing the number of lanes.
Secondly, we also notice that the value of the maximum standard error increases when increasing the number of lanes. If we compare the fundamental
diagrams in figure \ref*{fundamental diagram} and figure \ref*{standard error} it appears as if the car densities for which the flow rate reaches its maximum
value is vary similar to the car densities for which the standard error reaches its maximum value. This behavioir is very interesting and will be analyzed further
in the discussion.

\section*{Discussion}
\subsection*{Results discussion}

\subsection*{Model discussion}
% gaussian distribution of velocities?
In order to construct the above model several assumptions have been made. For example, the drivers have been assumed to be quite skilled
since a car will never perform a lane change if that means that a car behind will have to brake. In real life, this is of course true for some drivers 
but certainly not all.

Another assumption that has to be made since we are using the cellular automata is the fact that drivers only base their decisions on the current state. In other words, 
the drivers can never plan their driving in a way that skilled drivers would to in real life. For example ....

Another important aspect to mention are the possible consequences of using the period boundary conditions. When using period boundary conditions there is a risk
that a car might detect itself as the car in front. The car would then calculate the period distance to itself and adjust its speed accordingly. 
This is, of course, highly unrealistic and something we must be aware of when using the period boundary conditions. In order to reduce the risk of this happening
very short road lengths $L$ were avoided when running the simulation.

\subsection*{Summarizing conclusions}
\end{document}